<!DOCTYPE html>
<html>
<head>
<style type="text/css">
   .heavy {
      font: bold 30px monospace;
   }
   html, body {
     background: #000;
     margin: max(1vw,1vh);
   }
   .table_svg {
     display: block;
     top: 5vh;
     left: 5vw;
     width: 95vw;
     height: 95vh;
     /*background-color: #601;*/
   }
   .boundaries {
     fill: #630;
     height: 128px;
     width: 128px;
     stroke-width: 4px;
     stroke: #930;
   }
   .ul_bds {
     width: 100%;
   }
   .lr_bds {
     height: 100%;
   }
   .upper_bdy {
     y: 0;
   }
   .lower_bdy {
     x: 0;
     y: 1920;
   }
   .rght_bdy {
     x: 1920;
     y: 0;
   }

   .holes {
     r: 40;
     stroke: #888;
     stroke-width: 1px;
     fill: #000;
   }
   .hole1 {
      cx: 128px;
      cy: 128px;
   }
   .hole2 {
      cx: 128px;
      cy: 1920px;
   }
   .hole3 {
      cx: 128px;
      cy: 1024px;
   }
   .hole4 {
      cx: 1920px;
      cy: 128px;
   }
   .hole5 {
      cx: 1920px;
      cy: 1920px;
   }
   .hole6 {
      cx: 1920px;
      cy: 1024px;
   }

   .balls {
     r: 30;
     stroke: #ccc;
     stroke-width: 2px;
   }
   .solids {
     stroke-width: 0px;
   }
   .ball08 {
    stroke-width: 0px;
    fill: #000;
   }
   .striped {
     stroke-width: 13px;
     stroke: #bb8;
     r: 22;
   }
   .player_ball {
     fill: #999;
   }

   .ball_04 {
     fill: #305;
   }

   .ball_10 {
     fill: #009;
   }
   .ball_14 {
     fill: #090;
   }

   .ball_03 {
     fill: #900;
   }
   .ball_08 {
     fill: #000;
     r: 28;
     stroke-width: 8px;
     stroke: #c3c;
   }
   .ball_01 {
     fill: #990;
   }

   .ball_06 {
     fill: #090;
   }
   .ball_11 {
     fill: #900;
   }
   .ball_13 {
     fill: #550;
   }
   .ball_15 {
     fill: #502;
   }

   .ball_02 {
     fill: #009;
   }
   .ball_09 {
     fill: #990;
   }
   .ball_07 {
     fill: #502;
   }
   .ball_05 {
     fill: #550;
   }
   .ball_12 {
     fill: #305;
   }
</style>
</head>
<body>
<svg class="table_svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2048 2048">
  <g id="table_felt">
    <rect x=0 y=0 width=100% height=100% fill=#106510></rect>
  </g>
  <g id="bdy_group">
    <rect class="upper_bdy ul_bds boundaries"></rect>
    <rect class="lower_bdy ul_bds boundaries"></rect>
    <rect class="left_bdy  lr_bds boundaries"></rect>
    <rect class="rght_bdy  lr_bds boundaries"></rect>
  </g>
  <g id="holes">
    <circle class="holes hole1"/>
    <circle class="holes hole2"/>
    <circle class="holes hole3"/>
    <circle class="holes hole4"/>
    <circle class="holes hole5"/>
    <circle class="holes hole6"/>
  </g>
  <g id="cfl_balls">
    <circle cx=1086 cy=532 class="ball_01 solids  balls object_balls"/>
    <circle  cx=900 cy=424 class="ball_02 solids  balls object_balls"/>
    <circle  cx=962 cy=532 class="ball_03 solids  balls object_balls"/>
    <circle cx=1024 cy=640 class="ball_04 solids  balls object_balls"/>
    <circle cx=1086 cy=424 class="ball_05 solids  balls object_balls"/>
    <circle  cx=931 cy=478 class="ball_06 solids  balls object_balls"/>
    <circle cx=1024 cy=424 class="ball_07 solids  balls object_balls"/>
    <circle cx=1024 cy=532 class="ball_08 ball08  balls object_balls"/>
    <circle  cx=962 cy=424 class="ball_09 striped balls object_balls"/>
    <circle  cx=993 cy=586 class="ball_10 striped balls object_balls"/>
    <circle  cx=993 cy=478 class="ball_11 striped balls object_balls"/>
    <circle cx=1148 cy=424 class="ball_12 striped balls object_balls"/>
    <circle cx=1055 cy=478 class="ball_13 striped balls object_balls"/>
    <circle cx=1055 cy=586 class="ball_14 striped balls object_balls"/>
    <circle cx=1117 cy=478 class="ball_15 striped balls object_balls"/>
  </g>
  <g id="player_ball">
    <circle cx=1024 cy=1450 id="player_ball_sprite" class="ball_00 player_ball balls"/>
  </g>
</svg>
</body>
<script type="text/javascript">
  var last_mouse_up_coods = [-100,100];
  var last_down_on_white = false;
  var d = [0,0];

  function bind_to_clock_tick(ticked_action, millisecond_step) {
    function tick() {
      // ticked_action -> bool (weitermachen oder nicht?)
      var cancel_tick = ticked_action(millisecond_step);
      var now = Date.now();
      if ( !cancel_tick ) {
        //if not cancelled, schedule next tick
        setTimeout(tick, millisecond_step - (now%millisecond_step));
      }
    }
    tick()
  }

  function get_player_ball() {
    return document.getElementById("player_ball_sprite");
  }

  function get_ball_array() {
    // [...<html-collection> ] casts it to array
    balls = [...document.getElementsByClassName("object_balls")];
    player_ball = get_player_ball();
    player_ball_array = [player_ball,];
    balls = player_ball_array.concat(balls);
    return balls;
  }

  function set_balls_at_rest() {
    balls = get_ball_array();
    for ( let i = 0; i < balls.length; i++ )
    {
      ball = balls[i];
      ball.vx = 0
      ball.vy = 0
      ball.setAttribute("vx",0)
      ball.setAttribute("vy",0)
    }
  }
  set_balls_at_rest();

  function move_all_balls(ms_step) {
    var total_v = 0;
    balls = get_ball_array();
    //check if there's movement to be done still
    for ( let i=0; i<balls.length; i++)
    {
      total_v += Math.abs(balls[i].getAttribute("vx"));
      total_v += Math.abs(balls[i].getAttribute("vy"));
    }
    //not enough total velocity? kill next tick,
    //hence physics loop
    if ( Math.abs(total_v) < 10 ){
        cancel_next_tick = true;
        set_balls_at_rest();
        return cancel_next_tick;
    }

    //dampen all, felt-table friction or so
    for ( let i = 0; i < balls.length; i++ ){
      b = balls[i]
      vx = b.getAttribute("vx")
      vy = b.getAttribute("vy")
      n_old = Math.sqrt(vx*vx+vy*vy)
      n_new = n_old*97/100 //dampen by 3%
      vx = parseInt(Math.floor(vx*n_new/n_old))
      vy = parseInt(Math.floor(vy*n_new/n_old))
      //b.setAttribute("vx", vx)
      //b.setAttribute("vy", vy)
    }

    //preplan moving all balls according to their v's
    //collide them with boundaries
    //update v's accordingly
    for ( let i = 0; i < balls.length; i++ ){
      b = balls[i]
      cx = parseInt(b.getAttribute("cx"))
      cy = parseInt(b.getAttribute("cy"))
      vx = parseInt(b.getAttribute("vx"))
      vy = parseInt(b.getAttribute("vy"))
      r  = 32 //parseInt(b.getAttribute("r"))
      if ( ( cx - r <= 128 ) || ( cx + r >= 1920 ) ) {
        vx = -vx
        b.setAttribute("vx",vx)
      }
      if ( ( cy - r <= 128 ) || ( cy + r >= 1920 ) ) {
        b.vy = -b.vy
        b.setAttribute("vy",b.vy)
      }
    }
    //collide them with other balls
    //update v's accordingly
    for ( let i = 0; i < balls.length; i++ ) {
      for ( let j = i + 1; j < balls.length; j++ ) {
        b1 = balls[i];
        b1.cx = parseInt(b1.getAttribute("cx"))
        b1.cy = parseInt(b1.getAttribute("cy"))
        b1.vx = parseInt(b1.getAttribute("vx"))
        b1.vy = parseInt(b1.getAttribute("vy"))

        b2 = balls[j];
        b2.cx = parseInt(b2.getAttribute("cx"))
        b2.cy = parseInt(b2.getAttribute("cy"))
        b2.vx = parseInt(b2.getAttribute("vx"))
        b2.vy = parseInt(b2.getAttribute("vy"))

        dx = b1.cx - b2.cx
        dy = b1.cy - b2.cy
        distance = Math.floor(Math.sqrt(dx*dx+dy*dy));

        coll_distance = 1*b1.getAttribute("r")+1*b2.getAttribute("r")

        if ( distance <= coll_distance + 4 ) {
          // collide them
        }
      }
    }

    // move the sprites
    for ( let i = 0; i < balls.length; i++ ){
      balls[i].setAttribute("cx",1*balls[i].getAttribute("cx")+(ms_step/2000)*balls[i].getAttribute("vx"))
      balls[i].setAttribute("cy",1*balls[i].getAttribute("cy")+(ms_step/2000)*balls[i].getAttribute("vy"))
    }

    cancel_next_tick = false;
    //console.log("moved all balls "+` ${ms_step}`);
    return cancel_next_tick;
  }

  function white_mousedown(evt) {
    last_down_on_white = true;
  }

  svg = document.getElementsByTagName("svg")[0]
  var pt = svg.createSVGPoint();  // Created once for document
  //calls "set_white_ball_velocity" to start
  //movement tick
  function mouse_up_from_white_down(evt) {
    if (last_down_on_white) {
      pt.x = evt.clientX;
      pt.y = evt.clientY;
      // The cursor point, translated into svg coordinates
      var cursorpt =  pt.matrixTransform(svg.getScreenCTM().inverse());
      cursorpt.x = parseInt(cursorpt.x);
      cursorpt.y = parseInt(cursorpt.y);
      last_mouse_up_coods = [cursorpt.x,cursorpt.y];
      //console.log("last up: "+last_mouse_up_coods);
      player_ball = get_player_ball();
      px = parseInt(player_ball.getAttribute("cx"));
      py = parseInt(player_ball.getAttribute("cy"));
      d = [last_mouse_up_coods[0]-px,
           last_mouse_up_coods[1]-py];
      set_white_ball_velocity();
      last_down_on_white = false;
    }
  }

  function set_white_ball_velocity() {
    player_ball = get_player_ball();
    old_px = parseInt(player_ball.getAttribute("cx"))
    old_py = parseInt(player_ball.getAttribute("cy"))
    new_px = old_px + d[0];
    new_py = old_py + d[1];
    //console.log(new_px,new_py);
    player_ball.setAttribute("cx",new_px);
    player_ball.setAttribute("cy",new_py);
    player_ball.setAttribute("vx",d[0]);
    player_ball.setAttribute("vy",d[1]);
    bind_to_clock_tick(move_all_balls,5);
  }

  player_ball.addEventListener("mousedown",white_mousedown);
  svg.addEventListener("mouseup",mouse_up_from_white_down);
</script>
</html>