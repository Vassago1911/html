<!DOCTYPE html>
<html class="has-navbar-fixed-bottom">
<head>
</head>
<body>
<nav class="navbar is-dark is-fixed-bottom has-shadow">
<div class="navbar-start">
    <p class="navbar-item mono">
        MY GORILLAZ
    </p>
    <ul class="navbar-item mono">
    <li class="navbar-item mono">
        <a onclick="generate_gorilla_skyline()"> Reset Game </a>
    </li>
    <li class="navbar-item mono" style="visibility:hidden;">
        <a> Reset Game </a>
    </li>
    <li class="navbar-item mono" style="visibility:hidden;">
        <a> Reset Game </a>
    </li>
    </ul>
</div>
<div class="navbar-end">
    <ul class="navbar-item mono">
        <li><a class="right_nav_item">Settings</a></li>        
    </ul>
    <ul class="navbar-item mono">
        <li><a class="right_nav_item">Quit</a></li>
    </ul>
</div>    
</nav>
<nav class="navbar is-black" style="visibility:hidden;">
    <div class="navbar-start">
        <p class="navbar-item mono">
            MAIN MENU
        </p>
        <ul class="navbar-item mono">
        <li class="navbar-item mono">
            <a> Reset Game </a>
        </li>
        <li class="navbar-item mono" >
            <a> Reset Game </a>
        </li>
        <li class="navbar-item mono" >
            <a> Reset Game </a>
        </li>
        </ul>
    </div>
    <div class="navbar-end">
        <ul class="navbar-item mono">
            <li><a>Settings</a></li>        
        </ul>
        <ul class="navbar-item mono">
            <li><a>Quit</a></li>
        </ul>
    </div>    
    </nav>
<svg xmlns="http://www.w3.org/2000/svg" width="95%" height="90%" margin="max(4px,1vh,1vw)" viewBox="0 0 2048 2048">
  <defs>
    <clipPath id="cut_to_view">
      <rect id="view_frame" x="0" y="0" width="2048" height="2048"/>
    </clipPath>
  </defs>
  <g class="svg_frame" clip-path="url(#cut_to_view)"> 
    <circle class="sun_moon" cx="1024" cy="128" r="256"
            stroke="#333" stroke-width="16" stroke-opacity=".5" ></circle>
  </g>  
</svg>
</body>
<script type="text/javascript">
var math_natural_sign = -1;
function get_all_scrapers(){
    scrapers = [...document.getElementsByClassName("gen_re")];
    scrapers.sort(function(s1,s2){
        s1_x = parseInt(s1.getAttribute("x"));
        s2_x = parseInt(s2.getAttribute("x"));
        if ( s1_x < s2_x ) return -1;
        if ( s1_x > s2_x ) return  1;
        return 0;
    })
    return scrapers;
}

function get_all_players(){
    return [...document.getElementsByClassName("players")];
}

function bind_to_clock_tick(ticked_action, millisecond_step) {
    // ticked_action(millisecond_step) -> continue ticks?
    function tick() {
      // ticked_action -> bool (weitermachen oder nicht?)
      var cancel_tick = ticked_action(millisecond_step);
      var now = Date.now();
      if ( !cancel_tick ) {
        //if not cancelled, schedule next tick
        setTimeout(tick, millisecond_step - (now%millisecond_step));
      }
    }
    tick()
  }

//bind_to_clock_tick(scroll_view,5);

function random_rgb() {
    var o = Math.round, r = Math.random, s = 32 ; offset=32;
    return 'rgba(' + o(r()*s + offset ) +
               ',' + o(r()*s + offset ) + 
               ',' + o(r()*s + offset ) + ')';
}

function random_rgb_light() {
    var o = Math.round, r = Math.random, s = 32 ; offset=32;
    return 'rgba(' + o(r()*s + offset ) +
               ',' + o(r()*s + offset ) + 
               ',' + o(r()*s + offset ) + ',.25)';
}

function spawn_skyscraper(l,r,h) {
    //svg = document.getElementsByTagName("svg")[0];
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    re = document.createElementNS( "http://www.w3.org/2000/svg", "rect" )
    re.setAttribute("x",l);
    re.setAttribute("y",2048-h);
    re.setAttribute("width",r-l);
    re.setAttribute("height",h);
    re.setAttribute("fill",random_rgb());
    re.setAttribute("stroke-width",8);
    re.setAttribute("stroke","#111")
    re.classList.add("gen_re");
    svg_frame.appendChild(re);
}

function generate_gorilla_skyline() {
    //clear previous skyline
    sun_moon = document.getElementsByClassName("sun_moon")[0];
    sun_moon.setAttribute("fill",random_rgb_light());
    current_scrapers = get_all_scrapers();
    for ( let i = 0; i < current_scrapers.length; i++){
        current_scrapers[i].remove();
    }
    res_pts = [];
    l0 = -10;
    r0 = 0;
    while ( r0 < 2060 ) {
        r0 = l0 + 120 + Math.floor(Math.random()*280);
        height = 1024 + Math.floor( 480*2*(Math.random()-.5) )
        res_pts = res_pts.concat([[l0,r0,height]]);
        l0 = r0;
    }
    //return res_pts   
    for ( let i=0; i<res_pts.length; i++){
        params = res_pts[i];
        l = params[0];
        r = params[1];
        h = params[2];
        spawn_skyscraper(l,r,h);
    } 
    place_players();
}

function spawn_player(x,y){
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    c = document.createElementNS( "http://www.w3.org/2000/svg", "circle" )
    c.setAttribute("cx",x);
    c.setAttribute("cy",y-32);
    c.setAttribute("r",16);
    players = get_all_players();
    if (players.length > 0) {
        c.setAttribute("fill","#376");
    } else {
        c.setAttribute("fill","#60a");
    }        
    c.classList.add("players");
    svg_frame.appendChild(c);
}

function place_players(){   
    players = get_all_players();
    for (let i = 0; i<players.length; i++){
        players[i].remove();
    }
    function find_scraper_ix_for_x(x){
        scrapers = get_all_scrapers();
        for ( let i = 0; i<scrapers.length; i++){
            scraper = scrapers[i]
            l = 1*scraper.getAttribute("x");
            r = l+1*scraper.getAttribute("width");
            if ( ( l<x ) && (r>=x) ) {
                return i;
            }
        }
    }
    scrapers = get_all_scrapers();
    p1_x = 256 + Math.floor(256*Math.random());
    p2_x = 1920 - Math.floor(256*Math.random());
    p1_ix = find_scraper_ix_for_x(p1_x);
    p2_ix = find_scraper_ix_for_x(p2_x);
    p1_x = 1*scrapers[p1_ix].getAttribute("x") + scrapers[p1_ix].getAttribute("width")/2;
    p2_x = 1*scrapers[p2_ix].getAttribute("x") + scrapers[p2_ix].getAttribute("width")/2;
    p1_x = Math.max(64,p1_x);
    p2_x = Math.min(2000,p2_x);
    p1_y = 1*scrapers[p1_ix].getAttribute("y") + 16;
    p2_y = 1*scrapers[p2_ix].getAttribute("y") + 16;
    spawn_player(p1_x,p1_y);
    spawn_player(p2_x,p2_y);
}

svg = document.getElementsByTagName("svg")[0]
pt = svg.createSVGPoint();  // Created once for document
function get_overlay_click_coods(evt) {
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    // The cursor point, translated into svg coordinates
    var cursorpt =  pt.matrixTransform(svg.getScreenCTM().inverse());
    cursorpt.x = parseInt(cursorpt.x);
    cursorpt.y = parseInt(cursorpt.y);
    last_mouse_up_coods = [cursorpt.x,cursorpt.y];

    my_cx = 1*this.getAttribute("cx");
    my_cy = 1*this.getAttribute("cy");

    //console.log( last_mouse_up_coods )
    //console.log( last_mouse_up_coods[0] - my_cx );
    //console.log( last_mouse_up_coods[1] - my_cy );

    x = my_cx;
    y = my_cy;
    dx = last_mouse_up_coods[0] - my_cx;
    dy = last_mouse_up_coods[1] - my_cy;

    generate_aim_line(x,y,dx,dy);
    shoot(x,y,dx,dy);
    switch_player_turn();
}

function createbullet(x,y,dx,dy) {
    bullets = document.getElementsByClassName("bullet")
    for ( let i = 0; i < bullets.length; i++ ) {
        bullets[i].remove();
    }
    c = document.createElementNS( "http://www.w3.org/2000/svg", "circle" )
    c.setAttribute("cx",x);
    c.setAttribute("cy",y);
    c.setAttribute("r",8);
    c.setAttribute("fill","#fff");
    c.classList.add("bullet");
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    svg.appendChild(c);
}

function move_bullet(dt_ms) {
    c = 0.02;
//    cancel_following_tick = false;    
    bullet = document.getElementsByClassName("bullet")[0]
    if ( bullet.getAttribute("vx") == undefined ) {
        bullet.setAttribute("vx",dx)
    }
    if ( bullet.getAttribute("vy") == undefined ) {
        bullet.setAttribute("vy",dy)
    }
    cx = 1*bullet.getAttribute("cx")+c*dt_ms*bullet.getAttribute("vx")/50
    cy = 1*bullet.getAttribute("cy")+c*dt_ms*bullet.getAttribute("vy")/50-math_natural_sign
    vx = 1*bullet.getAttribute("vx")+c*dt_ms*bullet.getAttribute("vx")/625
    vy = 1*bullet.getAttribute("vy")+c*dt_ms*bullet.getAttribute("vy")/625-math_natural_sign
    bullet.setAttribute("cx",cx)
    bullet.setAttribute("cy",cy)
    bullet.setAttribute("vx",vx)
    bullet.setAttribute("vy",vy)
    if ( ( cy < 0 ) || ( cx < 0 ) || ( cx > 2048 ) ) {
        bullet.remove()
    }    
    if ( ( cx >= 2048 ) && ( cx < 0 ) && ( cx > 2048 ) ) {
        setTimeout(move_bullet,250,dt_ms);
    }
}

function shoot(x,y,dx,dy) {
    createbullet(x+dx,y+dy,dx,dy);  
    move_bullet(250);
    //bind_to_clock_tick(move_bullet,5);
    //curve = generate_bullet_curve(x,y,dx/512,dy/512);
    // movebullet(x,y,dx,dy);
    // destroybullet(x,y,dx,dy);
    // explodeatcollision(x,y,dx,dy); // add black circle as banana portal
}

function switch_player_turn() {
    wind_mu = 0 //( 2*Math.random()-1 ) / 1000
    if ( player_turn == 0 ) {
        player_turn = 1;        
    } else {
        player_turn = 0;
    }        
    setup_player_turn_ui();
    console.log(wind_mu);
    return;        
}

function generate_aim_line(x,y,dx,dy){
    former_aim_lines = document.getElementsByClassName(`aim_line_player${player_turn}`);
    for ( let i = 0; i < former_aim_lines.length ; i++ ) {
        former_aim_lines[i].remove()
    }
    aim_line = document.createElementNS( "http://www.w3.org/2000/svg", "line" );
    aim_line.setAttribute("x1",x + Math.sign(dx)*20)
    aim_line.setAttribute("y1",y - 8)
    aim_line.setAttribute("x2",x + dx)
    aim_line.setAttribute("y2",y + dy)
    aim_line.setAttribute("stroke-width",4)
    if ( player_turn == 0 ) {
        aim_line.setAttribute("stroke","#604")
    } else {
        aim_line.setAttribute("stroke","#064")
    }
    aim_line.classList.add(`aim_line_player${player_turn}`)
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    svg.appendChild(aim_line);
}

function draw_bullet_curve(curve_x_y_dx_dy_array) {
    curve_path = document.createElementNS( "http://www.w3.org/2000/svg", "path" );    
    arr = curve_x_y_dx_dy_array;
    console.log(arr);
    x0 = arr[0].x
    y0 = arr[0].y
    curve_path.setAttribute("d",`M ${x0} ${y0} `)
    cur_path = curve_path.getAttribute("d")
    for ( let i = 0 ; i < arr.length ; i++ ){
        xi = arr[i].x
        yi = arr[i].y        
        cur_path = cur_path + " L "+`${xi} ${yi}`
    }
    curve_path.setAttribute("d",cur_path)
    curve_path.setAttribute("stroke-width",4)
    if ( player_turn == 0 ) {
        curve_path.setAttribute("stroke","#604")
    } else {
        curve_path.setAttribute("stroke","#064")
    }
    curve_path.classList.add(`bullet_curve_player${player_turn}`)
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    svg.appendChild(curve_path);
}

function generate_bullet_curve(x,y,dx,dy){
    function euler_next(x,y,dx,dy,step_size){
        nv = Math.sqrt(dx*dx+dy*dy);
        x_new = x + step_size*dx
        y_new = y + step_size*dy
        dx_new = dx + step_size*wind_mu*nv*dx
        dy_new = dy + step_size*wind_mu*nv*dy - math_natural_sign*.1 //- step_size*.01 gravity-term
        tmp = {"x":x_new,"y":y_new,"dx":dx_new,"dy":dy_new}
        //console.log(tmp)
        return tmp
    }
    console.log(wind_mu);
    curve = [{"x":x,"y":y,"dx":dx,"dy": -dy},];
    xt = x; yt = y; dxt = dx; dyt = dy;
    while ( ( yt > 0 ) && ( xt > 0 ) && ( xt < 2048) ) {
        tmp = euler_next(xt,yt,dxt,dyt,.0069)
        curve = curve.concat([tmp,])
        xt = tmp.x
        yt = tmp.y
        dxt = tmp.dx
        dyt = tmp.dy
    }
    draw_bullet_curve(curve);
    return curve;
}

function setup_player_turn_ui(){    
    old_overlay = document.getElementsByClassName("overlay")
    for ( let i = 0; i < old_overlay.length; i++ ){
        old_overlay[i].remove();
    }
    overlay = document.createElementNS( "http://www.w3.org/2000/svg", "circle" );
    players = get_all_players();
    active_player = players[player_turn];
    overlay.setAttribute("cx",active_player.getAttribute("cx"));
    overlay.setAttribute("cy",active_player.getAttribute("cy"));
    overlay.setAttribute("r",256);
    overlay.setAttribute("fill","rgba(96,96,64,0)");
    overlay.setAttribute("stroke-width",4);
    overlay.setAttribute("stroke","rgba(96,96,128,.2)");
    overlay.classList.add("overlay")
    overlay.addEventListener("click",get_overlay_click_coods);
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    svg.appendChild(overlay);
}

generate_gorilla_skyline();
var player_turn = 1;
switch_player_turn();
</script>
<link rel="stylesheet" type="text/css" href="./bulma.css" />
<style type="text/css">
   html,body {
    font: monospace;
   }
   html {
       background-color: #000;
   }
   body {
       margin: 0;
   }
   svg {
     display: block;
     border: 0px solid #ccc;
     position: absolute;
     top: 5%;
     left: 5%;
     width: 90%;
     height: 90%;
     background: #000;     
   }
   .navbar {
    font: monospace;    
   }
   .mono {
    font-family: 'Courier New', Courier, monospace;
    font-size: max(1vh,1vw);
    color: #ccc;
   }
   a {
    color: rgb(16, 123, 113);
   }
   a:hover {
    color: #906;
   }
   .navbar-end {
    color: #161;
   }
   .navbar.is-dark {
     background-color: #222;
   }
   .right_nav_item {
    color: rgb(84,74,73);
   }
</style>
</html>