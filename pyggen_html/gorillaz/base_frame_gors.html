<!DOCTYPE html>
<html class="has-navbar-fixed-bottom">
<head>
</head>
<body>
<nav class="navbar is-dark is-fixed-bottom has-shadow">
<div class="navbar-start">
    <p class="navbar-item mono">
        MY GORILLAZ
    </p>
    <ul class="navbar-item mono">
    <li class="navbar-item mono">
        <a onclick="generate_gorilla_skyline()"> Reset Game </a>
    </li>
    <li class="navbar-item mono" style="visibility:hidden;">
        <a> Reset Game </a>
    </li>
    <li class="navbar-item mono" style="visibility:hidden;">
        <a> Reset Game </a>
    </li>
    </ul>
</div>
<div class="navbar-end">
    <ul class="navbar-item mono">
        <li><a class="right_nav_item">Settings</a></li>        
    </ul>
    <ul class="navbar-item mono">
        <li><a class="right_nav_item">Quit</a></li>
    </ul>
</div>    
</nav>
<nav class="navbar is-black" style="visibility:hidden;">
    <div class="navbar-start">
        <p class="navbar-item mono">
            MAIN MENU
        </p>
        <ul class="navbar-item mono">
        <li class="navbar-item mono">
            <a> Reset Game </a>
        </li>
        <li class="navbar-item mono" >
            <a> Reset Game </a>
        </li>
        <li class="navbar-item mono" >
            <a> Reset Game </a>
        </li>
        </ul>
    </div>
    <div class="navbar-end">
        <ul class="navbar-item mono">
            <li><a>Settings</a></li>        
        </ul>
        <ul class="navbar-item mono">
            <li><a>Quit</a></li>
        </ul>
    </div>    
    </nav>
<svg xmlns="http://www.w3.org/2000/svg" width="95%" height="90%" margin="max(4px,1vh,1vw)" viewBox="0 0 2048 2048">
  <defs>
    <clipPath id="cut_to_view">
      <rect id="view_frame" x="0" y="0" width="2048" height="2048"/>
    </clipPath>
  </defs>
  <g class="svg_frame" clip-path="url(#cut_to_view)"> 
    <circle class="sun_moon" cx="1024" cy="128" r="256"
            stroke="#333" stroke-width="16" stroke-opacity=".5" ></circle>
  </g>  
</svg>
</body>
<script type="text/javascript">
function get_all_scrapers(){
    scrapers = [...document.getElementsByClassName("gen_re")];
    scrapers.sort(function(s1,s2){
        s1_x = parseInt(s1.getAttribute("x"));
        s2_x = parseInt(s2.getAttribute("x"));
        if ( s1_x < s2_x ) return -1;
        if ( s1_x > s2_x ) return  1;
        return 0;
    })
    return scrapers;
}    

player1_rect = document.getElementById("p1")
player2_rect = document.getElementById("p2")
svg = document.getElementsByTagName("svg")[0]
pt = svg.createSVGPoint();  // Created once for document
function mouse_up_svg_coods(evt) {
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    // The cursor point, translated into svg coordinates
    var cursorpt =  pt.matrixTransform(svg.getScreenCTM().inverse());
    cursorpt.x = parseInt(cursorpt.x);
    cursorpt.y = parseInt(cursorpt.y);
    last_mouse_up_coods = [cursorpt.x,cursorpt.y];
}
function mouse_down_svg_coods(evt) {
    pt.x = evt.clientX;
    pt.y = evt.clientY;
    // The cursor point, translated into svg coordinates
    var cursorpt =  pt.matrixTransform(svg.getScreenCTM().inverse());
    cursorpt.x = parseInt(cursorpt.x);
    cursorpt.y = parseInt(cursorpt.y);
    last_mouse_down_coods = [cursorpt.x,cursorpt.y];
}

svg.addEventListener("mouseup",mouse_up_svg_coods)
svg.addEventListener("mousedown",mouse_down_svg_coods)

function bind_to_clock_tick(ticked_action, millisecond_step) {
    function tick() {
      // ticked_action -> bool (weitermachen oder nicht?)
      var cancel_tick = ticked_action(millisecond_step);
      var now = Date.now();
      if ( !cancel_tick ) {
        //if not cancelled, schedule next tick
        setTimeout(tick, millisecond_step - (now%millisecond_step));
      }
    }
    tick()
  }

//bind_to_clock_tick(scroll_view,5);

function random_rgb() {
    var o = Math.round, r = Math.random, s = 32 ; offset=32;
    return 'rgba(' + o(r()*s + offset ) +
               ',' + o(r()*s + offset ) + 
               ',' + o(r()*s + offset ) + ')';
}

function random_rgb_light() {
    var o = Math.round, r = Math.random, s = 32 ; offset=32;
    return 'rgba(' + o(r()*s + offset ) +
               ',' + o(r()*s + offset ) + 
               ',' + o(r()*s + offset ) + ',.25)';
}

function spawn_skyscraper(l,r,h) {
    //svg = document.getElementsByTagName("svg")[0];
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    re = document.createElementNS( "http://www.w3.org/2000/svg", "rect" )
    re.setAttribute("x",l);
    re.setAttribute("y",2048-h);
    re.setAttribute("width",r-l);
    re.setAttribute("height",h);
    re.setAttribute("fill",random_rgb());
    re.setAttribute("stroke-width",8);
    re.setAttribute("stroke","#000")
    re.classList.add("gen_re");
    svg_frame.appendChild(re);
}

function generate_gorilla_skyline() {
    //clear previous skyline
    sun_moon = document.getElementsByClassName("sun_moon")[0];
    sun_moon.setAttribute("fill",random_rgb_light());
    current_scrapers = get_all_scrapers();
    for ( let i = 0; i < current_scrapers.length; i++){
        current_scrapers[i].remove();
    }
    res_pts = [];
    l0 = -10;
    r0 = 0;
    while ( r0 < 2060 ) {
        r0 = l0 + 120 + Math.floor(Math.random()*280);
        height = 1024 + Math.floor( 480*2*(Math.random()-.5) )
        res_pts = res_pts.concat([[l0,r0,height]]);
        l0 = r0;
    }
    //return res_pts   
    for ( let i=0; i<res_pts.length; i++){
        params = res_pts[i];
        l = params[0];
        r = params[1];
        h = params[2];
        spawn_skyscraper(l,r,h);
    } 
    place_players();
}

function spawn_player(x,y){
    svg_frame = document.getElementsByClassName("svg_frame")[0]
    c = document.createElementNS( "http://www.w3.org/2000/svg", "circle" )
    c.setAttribute("cx",x);
    c.setAttribute("cy",y-32);
    c.setAttribute("r",16);
    players = [...document.getElementsByClassName("players")];
    if (players.length > 0) {
        c.setAttribute("fill","#376");
    } else {
        c.setAttribute("fill","#60a");
    }        
    c.classList.add("players");
    svg_frame.appendChild(c);
}

function place_players(){   
    players = [...document.getElementsByClassName("players")];
    for (let i = 0; i<players.length; i++){
        players[i].remove();
    }
    function find_scraper_ix_for_x(x){
        scrapers = get_all_scrapers();
        for ( let i = 0; i<scrapers.length; i++){
            scraper = scrapers[i]
            l = 1*scraper.getAttribute("x");
            r = l+1*scraper.getAttribute("width");
            if ( ( l<x ) && (r>=x) ) {
                return i;
            }
        }
    }
    scrapers = get_all_scrapers();
    p1_x = 256 + Math.floor(256*Math.random());
    p2_x = 1920 - Math.floor(256*Math.random());
    p1_ix = find_scraper_ix_for_x(p1_x);
    p2_ix = find_scraper_ix_for_x(p2_x);
    p1_x = 1*scrapers[p1_ix].getAttribute("x") + scrapers[p1_ix].getAttribute("width")/2;
    p2_x = 1*scrapers[p2_ix].getAttribute("x") + scrapers[p2_ix].getAttribute("width")/2;
    p1_x = Math.max(64,p1_x);
    p2_x = Math.min(2000,p2_x);
    p1_y = 1*scrapers[p1_ix].getAttribute("y") + 16;
    p2_y = 1*scrapers[p2_ix].getAttribute("y") + 16;
    spawn_player(p1_x,p1_y);
    spawn_player(p2_x,p2_y);
}
generate_gorilla_skyline();
</script>
<link rel="stylesheet" type="text/css" href="./bulma.css" />
<style type="text/css">
   html,body {
    font: monospace;
   }
   html {
       background-color: #000;
   }
   body {
       margin: 0;
   }
   svg {
     display: block;
     border: 0px solid #ccc;
     position: absolute;
     top: 5%;
     left: 5%;
     width: 90%;
     height: 90%;
     background: #000;     
   }
   .navbar {
    font: monospace;    
   }
   .mono {
    font-family: 'Courier New', Courier, monospace;
    font-size: max(1vh,1vw);
    color: #ccc;
   }
   a {
    color: rgb(16, 123, 113);
   }
   a:hover {
    color: #906;
   }
   .navbar-end {
    color: #161;
   }
   .navbar.is-dark {
     background-color: #222;
   }
   .right_nav_item {
    color: rgb(84,74,73);
   }
</style>
</html>